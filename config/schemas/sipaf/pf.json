{
    "$id": "schemas/sipaf/pf",
    "type": "object",
    "$meta": {
        "sql_processing": true,
        "sql_schema_name": "sipaf",
        "sql_table_name": "t_passages_faune",
        "genre": "M",
        "label": "passage à faune",
        "labels": "passages à faune",
        "label_field_name": "nom_pf",
        "geometry_field_name": "geom",
        "check_cruved": true,
        "filters": {
            "defs":{
                "haut_ouvrag_min": { "title": "Hauteur ouvrage min", "field": "haut_ouvrag", "type": "number", "filter_type": ">="},
                "haut_ouvrag_max":{ "title": "Hauteur ouvrage max", "field": "haut_ouvrag", "type": "number", "filter_type": "<="},
                "larg_ouvrag_min":{ "title": "Largeur ouvrage min", "field": "larg_ouvrag", "type": "number", "filter_type": ">="},
                "larg_ouvrag_max":{ "title": "Largeur ouvrage max", "field": "larg_ouvrag", "type": "number", "filter_type": "<="},
                "materiaux":{
                    "title": "Matériaux",
                    "field": "id_nomenclature_materiaux",
                    "filter_type": "=",
                    "type": "integer"
                },
                "departement": {
                    "title": "Département",
                    "field": "areas.id_area",
                    "filter_type": "=",
                    "type": "integer"
                },
                "commune": {
                    "title": "Commune",
                    "field": "areas.id_area",
                    "filter_type": "=",
                    "type": "integer"
                },
                "infrastructure": {
                    "title": "Infrastructure",
                    "field": "infrastructures.id_infrastructure",
                    "filter_type": "=",
                    "type": "integer"
                },
                "nom_pf": { "title": "Nom pf", "field": "nom_pf", "filter_type": "ilike"}
            },
            "layout": [
                "nom_pf",
                {
                    "key": "materiaux",
                    "type": "list-form",
                    "nomenclature_type": "PF_MATERIAUX"
                },
                {
                    "title": "Dimensions",
                    "items": [
                        {
                            "direction": "row",
                            "items": ["larg_ouvrag_min", "larg_ouvrag_max"]
                        },
                        {
                            "direction": "row",
                            "items": ["haut_ouvrag_min", "haut_ouvrag_max"]
                        }
      
                    ]
                },
                {
                    "title": "Localisation",
                    "items": [
                        {
                            "search": true,
                            "key": "departement",
                            "type": "list-form",
                            "area_type": "DEP"
                        },
                        {
                            "search": true,
                            "key": "commune",
                            "type": "list-form",
                            "area_type": "COM"
                        },
                        {
                            "search": true,
                            "key": "infrastructure",
                            "type": "list-form",
                            "schema_name": "schemas.sipaf.infrastructure",
                            "params": {
                                "filters": [
                                    { "field": "has_passages_faune", "type": "=", "value": "true" }
                                ],
                                "sorters": [
                                    { "field": "nomenclature_infrastructure_type.cd_nomenclature", "dir": "asc" },
                                    { "field": "infrastructure_number", "dir": "asc" }
                                ]
                            },
                            "data_reload_on_search": true,
                            "size": 10
                        }
                    ]
                },
                {
                    "type": "submit",
                    "title": "Rechercher"
                }
            ]
        },
        "map": {
            "fields": [
                "id_pf",
                "nom_pf"
            ],
            "popup_fields": [
                "id_pf",
                "nom_pf",
                "pi_ou_ps",
                "lb_materiaux"
            ]
        },
        "form": {
            "layout": [
                {
                   "title": "Informations",
                   "type": "fieldset",
                   "items": [
                        {
                            "direction": "row",
                            "items": [ "nom_pf", "id_op"]
                        },
                        {
                           "direction": "row",
                           "items": [
                            { "items": ["date_creat", "date_requal"] },
                            { "items": ["id_corr", "nom_corr"] },
                            { "items": ["id_obst", "nom_obst"] },
                            { "items": ["id_resv", "nom_resv"] }
                           ]
                        },
                        {
                            "items": [
                                {
                                    "key": "id_dataset",
                                    "type": "list-form",
                                    "schema_name": "schemas.utils.meta.jdd",
                                    "label": "Jeu de données",
                                    "params": {
                                        "filters": [{ "field":"modules.module_code", "type": "=", "value": "SIPAF"}]
                                    },
                                    "data_reload_on_search": true,
                                    "size": 10
                                }
                            ]
                        }
                   ]
                },
                {
                    "title": "Type",
                    "type": "fieldset",
                    "items": [
                        {
                            "direction": "row",
                            "items": [
                                "lb_typ_ouv",
                                "pi_ou_ps",
                                "oh",
                                "specificit"
                            ]
                        },
                        { "key": "id_nomenclature_materiaux", "type": "list-form", "nomenclature_type": "PF_MATERIAUX"}
                    ]
                },
                {
                    "direction": "row",
                    "items": [
                        {
                            "title": "Dimensions",
                            "type": "fieldset",
                            "items": [
                                { "direction": "row", "items": ["diam", "long_franch"]},
                                { "direction": "row", "items": ["larg_ouvrag", "haut_ouvrag"]},
                                { "direction": "row", "items": ["larg_disp", "haut_disp"]}
                            ]
                        },
                        {
                            "title": "Localisation",
                            "type": "fieldset",
                            "direction": "row",
                            "items": [
                                { "items": ["pk", "pr", "pr_abs"] }
                            ]
                        }
                    ]
                },
                {
                    "title": "Banquette (OH)",
                    "type": "fieldset",
                    "direction": "row",
                    "items": [
                        { "key": "id_nomenclature_oh_position", "type": "list-form", "nomenclature_type": "PF_OH_POSITION"},
                        { "key": "id_nomenclature_oh_banq_type", "type": "list-form", "nomenclature_type": "PF_OH_BANQ_TYPE"},
                        { "key": "id_nomenclature_oh_banq_caract", "type": "list-form", "nomenclature_type": "PF_OH_BANQ_CARACT"},
                        "oh_tirant"
                    ]
                }
            ]
        },
        "details": {
            "layout": [
                {
                   "title": "Informations",
                   "type": "fieldset",
                   "items": [
                        {
                            "direction": "row",
                            "items": [ "nom_pf", "id_op"]
                        },
                        {
                           "direction": "row",
                           "items": [
                            { "items": ["date_creat", "date_requal"] },
                            { "items": ["id_corr", "nom_corr"] },
                            { "items": ["id_obst", "nom_obst"] },
                            { "items": ["id_resv", "nom_resv"] }
                           ]
                        }
                   ]
                },
                {
                    "title": "Type",
                    "type": "fieldset",
                    "items": [
                        {
                            "direction": "row",
                            "items": [
                                "lb_typ_ouv",
                                "pi_ou_ps",
                                "oh",
                                "specificit"
                            ]
                        },
                        "nomenclature_materiaux.label_fr"
                    ]
                },
                {
                    "direction": "row",
                    "items": [
                        {
                            "title": "Dimensions",
                            "type": "fieldset",
                            "items": [
                                { "direction": "row", "items": ["diam", "long_franch"]},
                                { "direction": "row", "items": ["larg_ouvrag", "haut_ouvrag"]},
                                { "direction": "row", "items": ["larg_disp", "haut_disp"]}
                            ]
                        },
                        {
                            "title": "Localisation",
                            "direction": "row",
                            "type": "fieldset",
                            "items": [
                                { "items": ["pk", "pr", "pr_abs"] },
                                { "items":
                                    [
                                        { "key": "commune", "title": "Commune", "key_value": "areas.area_name", "filters": [{ "key":"areas.area_type.type_code", "value": "COM"}] },
                                        { "key": "departement", "title": "Département", "key_value": "areas.area_name", "filters": [{ "key":"areas.area_type.type_code", "value": "DEP"}] },
                                        { "title": "Infrastrucure", "key": "label_infrastructures" }
                                    ]
                                }
                            ]
                        }
                        // {
                        //     "items": "geom"
                        // }
                    ]
                },
                {
                    "title": "Banquette (OH)",
                    "type": "fieldset",
                    "direction": "row",
                    "items": [
                        "nomenclature_oh_position.label_fr",
                        "nomenclature_oh_banq_type.label_fr",
                        "nomenclature_oh_banq_caract.label_fr",
                        "oh_tirant"
                    ]
                }
            ]
        },
        "table": {
            "columns": [
                "id_pf",
                "uuid_pf",
                "nom_pf",
                "nom_corr",
                "nomenclature_materiaux.label_fr",
                "date_creat",
                "larg_ouvrag",
                "haut_ouvrag",
                "larg_disp",
                "haut_disp",
                "long_franch",
                "diam",
                "comment",
                "x",
                "y"
            ],
            "columns_short": [
                "id_pf",
                "nom_pf",
                "nomenclature_materiaux.label_fr",
                "label_infrastructures"
            ]
        }
    },
    "properties": {
        "id_pf": {
            "type": "integer",
            "title": "ID PAF",
            "primary_key": true
        },
        "id_op": {
            "type": "string",
            "title": "Code de l'ouvrage pour le gestionnaire"
        },
        "an_ref_com": {
            "type": "string",
            "title": "Année de référence commune"
        },
        "issu_requa": {
            "type": "string",
            "title": "Issu d'une requalification ?"
        },
        "uuid_pf": {
            "type": "uuid",
            "title": "UUID PF"
        },
        "pi_ou_ps": {
            "type": "string",
            "title": "PI ou PF"
        },
        "pk": {
            "type": "number",
            "title": "PK"
        },
        "pr": {
            "type": "number",
            "title": "PR"
        },
        "pr_abs": {
            "type": "number",
            "title": "PR_abs"
        },
        "x": {
            "type": "number",
            "title": "X"
        },
        "y": {
            "type": "number",
            "title": "Y"
        },
        "nom_pf": {
            "type": "string",
            "title": "Nom Passage Faune"
        },
        "date_creat": {
            "type": "string",
            "title": "Date de creation"
        },
        "date_requal": {
            "type": "string",
            "title": "Date de requalification"
        },
        "larg_ouvrag": {
            "type": "number",
            "title": "Largeur ouvrage"
        },
        "haut_ouvrag": {
            "type": "number",
            "title": "Hauteur ouvrage"
        },
        "long_franch": {
            "type": "number",
            "title": "Longueur"
        },
        "diam": {
            "type": "number",
            "title": "Diamètre"
        },
        "larg_disp": {
            "type": "number",
            "title": "Largeur disponible"
        },
        "haut_disp": {
            "type": "number",
            "title": "Hauteur disponible"
        },
        "specificit": {
            "type": "string",
            "title": "Spécificité"
        },
        "lb_typ_ouv": {
            "type": "string",
            "title": "Type d'ouvrage"
        },
        "lb_materiaux": {
            "type": "string",
            "title": "Matériaux"
        },
        "ep_materiaux": {
            "type": "number",
            "title": "Epaisseur matériaux"
        },
        "oh": {
            "type": "string",
            "title": "Ouvrage hydrolique"
        },
        "oh_position": {
            "type": "string",
            "title": "OH position"
        },
        "oh_caract": {
            "type": "string",
            "title": "OH caract"
        },
        "oh_banqu": {
            "type": "string",
            "title": "OH caract"
        },
        "oh_tirant": {
            "type": "string",
            "title": "OH tirat"
        },
        "id_cer": {
            "type": "string",
            "title": "Reprend id unique du cer"
        },
        "id_corr": {
            "type": "string",
            "title": "ID Corridor"
        },
        "nom_corr": {
            "type": "string",
            "title": "Nom Corridor"
        },
        "id_resv": {
            "type": "string",
            "title": "ID resv"
        },
        "nom_resv": {
            "type": "string",
            "title": "Nom resv"
        },
        "id_obst": {
            "type": "string",
            "title": "ID obstacle"
        },
        "nom_obst": {
            "type": "string",
            "title": "Nom obstacle"
        },
        "comment": {
            "type": "string",
            "title": "Commentaire"
        },
        "geom": {
            "type": "geometry",
            "geometry_type": "point",
            "srid": 4326,
            "title": "Geométrie",
            "index": true
        },


        // fk
        "id_dataset": {
            "type": "integer",
            "title": "id_dataset",
            "foreign_key": true,
            "schema_name": "schemas.utils.meta.jdd"
        },
        "id_nomenclature_materiaux": {
            "type": "integer",
            "title": "Matériaux",
            "foreign_key": true,
            "schema_name": "schemas.utils.nomenclature.nomenclature",
            "nomenclature_type": "PF_MATERIAUX"
        },
        "id_nomenclature_oh_position": {
            "type": "integer",
            "title": "OH Position",
            "foreign_key": true,
            "schema_name": "schemas.utils.nomenclature.nomenclature",
            "nomenclature_type": "PF_OH_POSITION"
        },
        "id_nomenclature_oh_banq_caract": {
            "type": "integer",
            "title": "OH Caractrisation banquette",
            "nomenclature_type": "PF_OH_BANQ_CARACT",
            "foreign_key": true,
            "schema_name": "schemas.utils.nomenclature.nomenclature"
        },
        "id_nomenclature_oh_banq_type": {
            "type": "integer",
            "title": "OH type de banquette",
            "foreign_key": true,
            "schema_name": "schemas.utils.nomenclature.nomenclature",
            "nomenclature_type": "PF_OH_BANQ_TYPE"
        },


        // relations
        "nomenclature_materiaux": {
            "type": "relation",
            "relation_type": "n-1",
            "schema_name": "schemas.utils.nomenclature.nomenclature",
            "title": "Matériaux",
            "local_key": "id_nomenclature_materiaux"
        },
        "nomenclature_oh_position": {
            "type": "relation",
            "relation_type": "n-1",
            "schema_name": "schemas.utils.nomenclature.nomenclature",
            "title": "Position banquette",
            "local_key": "id_nomenclature_oh_position"
        },
        "nomenclature_oh_banq_caract": {
            "type": "relation",
            "relation_type": "n-1",
            "schema_name": "schemas.utils.nomenclature.nomenclature",
            "title": "OH Caractrisation banquette",
            "local_key": "id_nomenclature_oh_banq_caract"
        },
        "nomenclature_oh_banq_type": {
            "type": "relation",
            "relation_type": "n-1",
            "schema_name": "schemas.utils.nomenclature.nomenclature",
            "title": "OH type de banquette",
            "local_key": "id_nomenclature_oh_banq_type"
        },
        "areas": {
            "type": "relation",
            "title": "Areas",
            "relation_type": "n-n",
            "schema_name": "schemas.utils.ref_geo.area",
            "schema_dot_table": "sipaf.cor_area_pf",
            "trigger": {
                "name": "intersect_ref_geo"
            }
        },
        "infrastructures": {
            "type": "relation",
            "title": "Infrastructures",
            "relation_type": "n-n",
            "schema_name": "schemas.sipaf.infrastructure",
            "schema_dot_table": "sipaf.cor_infrastructure_pf",
            "trigger": {
                "name": "d_within",
                "distance": 0.001
            }
        }
        ,

        // column properties
        "nb_infrastructures": {
            "type": "integer",
            "title": "Infrastrutures",
            "column_property": "nb",
            "relation_key": "infrastructures"
        }
        ,

        "label_infrastructures": {
            "type": "string",
            "title": "Infrastrutures",
            "column_property": "label",
            "relation_key": "infrastructures",
            "label_key": "infrastructure_name"
        }

    }
}