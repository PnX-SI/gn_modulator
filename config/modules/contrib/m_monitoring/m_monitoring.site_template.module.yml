type: module
code: m_monitoring.site_template
title: "Module monitoring"
description: "Module monitoring, apporte les schemas des sites, visites, etc..."

template_defaults:

  site_filters_fields:
    display: tabs
    items:
      - label: Infos
        items:
          - code
          - name
          - id_site_category

      - label: Localisation
        items:
          - key: region
            title: Région
            type: list_form
            return_object: "true"
            additional_fields:
              - area_code
            area_type: REG
            sort: area_name

          - key: departement
            title: Département
            type: list_form
            reload_on_search: true
            area_type: DEP
            return_object: true
            additional_fields:
              - area_code
            label_field_name: code_name
            sort: code_name
            filters: |
              __f__data?.region
                ? `area_code in ${utils.departementsForRegion(data.region.area_code).join(';')}`
                : null

          - key: commune
            reload_on_search: true
            title: Commune
            type: list_form
            area_type: COM
            label_field_name: name_code
            filters: |
              __f__data?.departement
                ? `area_code like ${data.departement.area_code}%`
                : data?.region
                  ? utils.departementsForRegion(data.region.area_code)
                      .map(departementCode => `area_code like ${departementCode}%`)
                      .join(',|,')
                  : null
            sort: area_name

          - key: infrastructure
            title: Infrastructure
            type: list_form
            object_code: ref_geo.linear_group
            module_code: MODULES
            filters: linears.type.type_code = RTE
            sort: name
            reload_on_search: true
            page_size: 10

  site_filters_defs:
    category:
      field: category.id_category
    region:
      field: areas.id_area
      key: id_area
    departement:
      field: areas.id_area
      key: id_area
    commune:
      field: areas.id_area
    infrastructure:
      field: linears.id_linear

  site_table_fields:
    - code
    - name
    - category.name
    - nb_visits
    - last_visit_date_min

  site_map_popup_fields:
    - code
    - name
    - description
    - nomenclature_type_site.label_fr
    - category.name
    - nb_visits
    - last_visit_date_min


module:
  module_label: __MODULE_LABEL__
  module_desc: __MODULE_DESC__
  module_picto: fa-puzzle-piece
  active_frontend: true
objects:
  site:
    cruved: CRUD
    schema_code: m_monitoring.site
  visit:
    cruved: CRUD
    schema_code: m_monitoring.visit
  site_group:
    cruved: CRUD
    schema_code: m_monitoring.site_group
    map:
      style:
        color: red
  observation:
    cruved: CRUD
    schema_code: m_monitoring.observation
  module:
    cruved: R
    schema_code: commons.module
  category:
    cruved: R
    schema_code: m_monitoring.site_category

tree:
  site:
    visit:
      observation:

pages_definition:

  site:
    list:
      layout:
        code: m_monitoring.site_list
        template_params:
          site_table_fields: __SITE_TABLE_FIELDS__
          site_map_popup_fields: __SITE_MAP_POPUP_FIELDS__
          site_filters_fields: __SITE_FILTERS_FIELDS__
          site_filters_defs: __SITE_FILTERS_DEFS__
      root: true
    details:
      layout:
        code: m_monitoring.site_details
    create:
      layout:
        code: m_monitoring.site_edit
    edit:
      layout:
        code: m_monitoring.site_edit

  visit:
    details:
      layout:
        code: m_monitoring.visit_details
    edit:
      layout:
        code: m_monitoring.visit_edit
    create:
      layout:
        code: m_monitoring.visit_edit
  observation:
    details:
      layout:
        code: m_monitoring.observation_details
    edit:
      layout:
        code: m_monitoring.observation_edit
    create:
      layout:
        code: m_monitoring.observation_edit

  # site_group_create:
  #   url: site_group_create
  #   layout:
  #     code: m_monitoring.site_group_edit

  # site_group_details:
  #   url: site_group_details/:id_site_group
  #   layout:
  #     code: m_monitoring.site_group_details
  #   objects:
  #     site_group:
  #       value: ":id_site_group"
  #       prefilters: id_site_group = :id_site_group
  #     site:
  #       prefilters: groups.id_site_group = :id_site_group
  #     visit:
  #       prefilters: site.groups.id_site_group = :id_site_group
  # site_group_edit:
  #   url: site_group_edit/:id_site_group
  #   layout:
  #     code: m_monitoring.site_group_edit
  #   objects:
  #     site_group:
  #       value: ":id_site_group"
